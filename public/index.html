<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Modern URL Shortener</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CDN for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<body class="p-4">
    <div class="container">
        <h2 class="mb-4">URL Shortener</h2>
        <form id="shorten-form" class="mb-4">
            <input type="url" name="url" placeholder="Enter URL" class="form-control mb-2" required>
            <input type="text" name="shortCode" placeholder="Optional short code" class="form-control mb-2">
            <input type="datetime-local" name="expiresAt" class="form-control mb-2">
            <button class="btn btn-primary w-100">Shorten</button>
        </form>

        <h2>Shortened URLs</h2>
        <ul id="shortened-urls" class="list-group"></ul>
        <div id="loading-spinner" class="text-center my-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          
    </div>

    <script>
        const list = document.getElementById("shortened-urls");

        async function fetchLinks() {
  const spinner = document.getElementById("loading-spinner");
  spinner.style.display = "block"; // ⏳ Show spinner

  try {
    const res = await fetch("/links");
    const links = await res.json();

    list.innerHTML = "";

    if (Object.keys(links).length === 0) {
      list.innerHTML = "<li>No short URLs found.</li>";
      return;
    }

    for (const [shortCode, linkInfo] of Object.entries(links)) {
      const li = document.createElement("li");
      li.className = "list-group-item d-flex justify-content-between";

      li.innerHTML = `
        <span>
          <a href="/${shortCode}" target="_blank">${window.location.origin}/${shortCode}</a><br>
          <small>
            ${linkInfo.clicks} clicks • ${
              linkInfo.expiresAt
                ? new Date(linkInfo.expiresAt) < new Date()
                  ? "Expired"
                  : "Expires: " + new Date(linkInfo.expiresAt).toLocaleString()
                : "No Expiry"
            }
          </small>
        </span>
        <div class="d-flex gap-2">
          <div class="icon-btn" onclick="copyToClipboard('${window.location.origin}/${shortCode}')">
            <i class="fas fa-copy"></i>
          </div>
          <div class="icon-btn text-danger" onclick="deleteLink('${shortCode}')">
            <i class="fas fa-trash-alt"></i>
          </div>
          <div class="icon-btn text-warning" onclick="editLink('${shortCode}', '${linkInfo.url}')">
            <i class="fas fa-edit"></i>
          </div>
          <div class="icon-btn text-info" onclick="shareLink('${window.location.origin}/${shortCode}')">
            <i class="fas fa-share-alt"></i>
          </div>
        </div>
      `;

      list.appendChild(li);
    }
  } catch (err) {
    console.error("Fetch error:", err);
    list.innerHTML = "<li>Error loading links. Try again later.</li>";
  } finally {
    spinner.style.display = "none"; // ✅ Hide spinner
  }
}


        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => alert("Copied!"));
        }

        document.getElementById("shorten-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const body = JSON.stringify({
                url: form.get("url"),
                shortCode: form.get("shortCode"),
                expiresAt: form.get("expiresAt"),
            });

            const res = await fetch("/shorten", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body
            });

            if (res.ok) {
                await fetchLinks();
                alert("Link shortened successfully!");
                e.target.reset();
            } else {
                const error = await res.text();
                alert(error);
            }
        });

        fetchLinks(); // load on start
        function showToast(message) {
            const toast = document.getElementById("toast");
            const body = document.getElementById("toast-body");
            body.textContent = message;
            toast.classList.add("show");
            setTimeout(() => toast.classList.remove("show"), 3000);
        }
        function hideToast() {
            document.getElementById("toast").classList.remove("show");
        }
        async function deleteLink(code) {
            const res = await fetch(`/delete/${code}`, { method: "DELETE" });
            if (res.ok) {
                showToast("Link deleted ✅");
                fetchLinks();
            } else {
                showToast("Failed to delete ❌");
            }
        }
        function editLink(code, currentUrl) {
            const newUrl = prompt("Edit URL:", currentUrl);
            if (!newUrl) return;
            fetch("/edit", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code, newUrl }),
            }).then(async res => {
                if (res.ok) {
                    showToast("Updated ✅");
                    fetchLinks();
                } else {
                    showToast("Update failed ❌");
                }
            });
        }
        function shareLink(url) {
            if (navigator.share) {
                navigator.share({ title: "Check this short URL", url });
            } else {
                copyToClipboard(url);
                showToast("Link copied to clipboard ✅");
            }
        }
    </script>

    <style>
        .icon-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            background-color: rgb(243, 241, 239);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .icon-btn:hover {
            background-color: #e0e0e0;
        }
        .icon-btn i {
            font-size: 18px;
        }
        .icon-btn.text-warning i {
            color: rgb(39, 109, 240); /* Edit icon color */
        }
    </style>

    <div id="toast" class="position-fixed bottom-0 end-0 m-3 toast align-items-center text-white bg-primary border-0"
        role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toast-body">Message</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" onclick="hideToast()"></button>
        </div>
    </div>
</body>

</html>
